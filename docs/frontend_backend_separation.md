# 前后端分离架构设计文档

## 1. 概述

本文档详细说明如何将当前的Flask模板渲染应用重构为前后端分离架构，前端使用现代JavaScript框架，后端提供RESTful API服务。

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────┐      HTTP/JSON      ┌─────────────┐
│   前端应用   │<─────────────────>│  后端API服务 │
└─────────────┘                    └─────────────┘
     React                            Flask API
```

### 2.2 技术栈选择

#### 前端技术栈
- **框架**: React.js
- **UI组件库**: Material-UI 或 Ant Design
- **状态管理**: React Context API + Hooks
- **路由**: React Router
- **HTTP客户端**: Axios
- **构建工具**: Vite

#### 后端技术栈
- **框架**: Flask
- **API规范**: RESTful
- **数据序列化**: Flask-Marshmallow
- **跨域支持**: Flask-CORS
- **认证**: JWT (JSON Web Tokens)

## 3. 前端职责

### 3.1 核心职责
- 用户界面渲染与交互
- 客户端路由管理
- 状态管理
- API请求处理
- 数据缓存

### 3.2 具体功能模块

#### 3.2.1 页面组件
- **首页**: 显示驱动器和系统文件夹
- **浏览页**: 文件和目录浏览界面
- **媒体预览**: 图片、视频预览组件

#### 3.2.2 布局组件
- **导航栏**: 顶部导航
- **面包屑**: 路径导航
- **侧边栏**: 目录树导航
- **文件列表**: 列表/网格视图切换

#### 3.2.3 工具组件
- **文件图标**: 根据文件类型显示不同图标
- **视图切换器**: 列表/网格视图切换
- **分页控制**: 文件列表分页

### 3.3 前端路由设计

```
/                 - 首页(驱动器和系统文件夹)
/browse/:path     - 浏览特定路径
/preview/:type/:path - 预览媒体文件
```

## 4. 后端职责

### 4.1 核心职责
- 提供RESTful API
- 文件系统操作
- 数据处理和转换
- 媒体文件处理
- 错误处理和日志记录

### 4.2 API端点设计

#### 4.2.1 系统信息API

```
GET /api/drives
返回: 系统可用驱动器列表

GET /api/system-folders
返回: 系统特殊文件夹列表和路径
```

#### 4.2.2 文件操作API

```
GET /api/browse?path={path}
返回: 指定路径的文件和目录列表

GET /api/download?path={path}
返回: 文件下载流

GET /api/thumbnail?path={path}
返回: 视频缩略图
```

#### 4.2.3 媒体处理API

```
GET /api/media/info?path={path}
返回: 媒体文件的元数据信息
```

### 4.3 数据模型

#### 文件/目录项
```json
{
  "name": "文件名",
  "path": "完整路径",
  "type": "file|directory",
  "size": 1024,
  "modified": "2023-06-01T12:00:00Z",
  "icon": "file-pdf",
  "color": "danger",
  "thumbnail": "缩略图路径(如果有)"
}
```

## 5. 数据流

### 5.1 浏览目录流程

1. 用户访问特定路径
2. 前端发送API请求到`/api/browse?path={path}`
3. 后端处理请求，获取文件系统信息
4. 后端返回JSON格式的文件和目录列表
5. 前端接收数据并渲染界面

### 5.2 媒体预览流程

1. 用户点击媒体文件
2. 前端检查文件类型并打开预览模态框
3. 对于视频文件，前端请求`/api/thumbnail?path={path}`获取缩略图
4. 用户点击播放时，前端请求`/api/download?path={path}`获取媒体流
5. 前端使用HTML5媒体元素播放内容

## 6. 安全考虑

### 6.1 API安全
- 实施路径遍历防护
- 添加请求速率限制
- 验证文件路径参数

### 6.2 跨域资源共享(CORS)
- 配置适当的CORS策略
- 限制允许的源和方法

## 7. 部署方案

### 7.1 开发环境
- 前端: `npm run dev` (Vite开发服务器)
- 后端: `flask run --debug`

### 7.2 生产环境
- 前端: 构建静态资产并由Nginx提供服务
- 后端: Gunicorn + Nginx反向代理

## 8. 迁移步骤

### 8.1 后端迁移
1. 将现有Flask路由转换为API端点
2. 移除模板渲染逻辑
3. 添加JSON响应和错误处理
4. 实现CORS支持
5. 添加API文档

### 8.2 前端迁移
1. 创建React项目结构
2. 实现组件层次结构
3. 从现有模板提取UI设计和逻辑
4. 实现API客户端服务
5. 添加路由和状态管理

## 9. 测试策略

### 9.1 后端测试
- API端点单元测试
- 文件系统操作集成测试
- 性能和负载测试

### 9.2 前端测试
- 组件单元测试
- 用户界面集成测试
- 端到端测试

## 10. 性能优化

### 10.1 后端优化
- 实现响应缓存
- 分页和懒加载支持
- 异步处理大型目录

### 10.2 前端优化
- 组件懒加载
- 资源预加载
- 图片和媒体优化
- 状态管理优化