{% extends "base.html" %}

{% block content %}
<!-- 修改容器背景和间距 -->
<div class="container-fluid bg-dark text-light min-vh-100" data-bs-theme="dark">
    <!-- 修改面包屑导航颜色 -->
    <nav aria-label="breadcrumb" class="pt-3">
        <ol class="breadcrumb bg-dark border-primary p-3 rounded-3">
            <li class="breadcrumb-item">
                <a href="{{ url_for('index') }}" class="text-purple-400"><i class="fas fa-home"></i></a>
            </li>
            {% set parts = [] %}
            {% for part in current_path.split('\\') if part %}
                {% if loop.first %}
                    {% set _ = parts.append(part + '\\') %}
                {% else %}
                    {% set _ = parts.append(part) %}
                {% endif %}
            {% endfor %}
            
            {% for part in parts %}
                <li class="breadcrumb-item {% if not loop.last %}active{% endif %}">
                    {% if loop.last %}
                        {{ part }}
                    {% else %}
                        <a href="{{ url_for('browse', dirpath=parts[:loop.index]|join('\\')) }}">
                            {{ part }}
                            {% if loop.first %}<i class="fas fa-level-up-alt ms-1"></i>{% endif %}
                        </a>
                    {% endif %}
                </li>
            {% endfor %}
        </ol>
    </nav>

    <!-- 改为可折叠侧边栏布局 -->
    <!-- 修正侧边栏布局 -->
    <div class="row g-0">
        <!-- 可折叠侧边栏 -->
        <!-- 在面包屑导航下方添加常驻展开按钮 -->
        <nav aria-label="breadcrumb" class="pt-3 position-relative">
            <button class="btn btn-purple position-absolute start-0 ms-3 d-lg-none" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#sidebar"
                    style="z-index: 1000; top: 50%; transform: translateY(-50%);">
                <i class="fas fa-bars"></i>
            </button>
            <ol class="breadcrumb bg-dark border-primary p-3 rounded-3 ps-5">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('index') }}" class="text-purple-400"><i class="fas fa-home"></i></a>
                </li>
                {% set parts = [] %}
                {% for part in current_path.split('\\') if part %}
                    {% if loop.first %}
                        {% set _ = parts.append(part + '\\') %}
                    {% else %}
                        {% set _ = parts.append(part) %}
                    {% endif %}
                {% endfor %}
                
                {% for part in parts %}
                    <li class="breadcrumb-item {% if not loop.last %}active{% endif %}">
                        {% if loop.last %}
                            {{ part }}
                        {% else %}
                            <a href="{{ url_for('browse', dirpath=parts[:loop.index]|join('\\')) }}">
                                {{ part }}
                                {% if loop.first %}<i class="fas fa-level-up-alt ms-1"></i>{% endif %}
                            </a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ol>
        </nav>
        
        <!-- 修改侧边栏关闭按钮逻辑 -->
        <!-- 修改汉堡菜单按钮显示逻辑 -->
        <button class="btn btn-purple position-absolute start-0 ms-3" 
                data-bs-toggle="collapse" 
                data-bs-target="#sidebar"
                style="z-index: 1000; top: 50%; transform: translateY(-50%); display: none;">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- 修改侧边栏关闭按钮 -->
        <div class="col-lg-2 collapse-horizontal collapse show" id="sidebar">
            <div class="card bg-dark border-purple shadow-lg me-2">
                <div class="card-header bg-purple text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-folder-tree me-2"></i>目录导航</span>
                    <button class="btn btn-link text-white p-0" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#sidebar"
                            aria-label="Toggle sidebar">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <!-- 删除多余的card-header -->
                <div class="list-group list-group-flush">
                    {% for dir in dirs %}
                    <a href="{{ url_for('browse', dirpath=dir.path) }}" 
                       class="list-group-item list-group-item-action file-item">
                        <i class="fas fa-folder text-warning me-2"></i>{{ dir.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 添加全局展开按钮 -->
        <button class="btn btn-purple position-fixed start-0 mt-5 ms-3 sidebar-expander" 
                style="display: none; z-index: 999;"
                data-bs-toggle="collapse" 
                data-bs-target="#sidebar">
            <i class="fas fa-chevron-right"></i>
        </button>

        <style>
        .sidebar-expander {
            transition: transform 0.3s ease;
            transform: translateX(-50%);
        }
        .sidebar-expander:hover {
            transform: translateX(0);
        }
        </style>

        <script>
        // 更新侧边栏状态跟踪
        document.getElementById('sidebar').addEventListener('hidden.bs.collapse', function () {
            localStorage.setItem('sidebarCollapsed', 'true');
            document.querySelector('.sidebar-expander').style.display = 'block';
        });

        document.getElementById('sidebar').addEventListener('shown.bs.collapse', function () {
            localStorage.removeItem('sidebarCollapsed');
            document.querySelector('.sidebar-expander').style.display = 'none';
        });

        // 初始化逻辑
        document.addEventListener('DOMContentLoaded', () => {
            const expander = document.querySelector('.sidebar-expander');
            if(localStorage.getItem('sidebarCollapsed') === 'true') {
                new bootstrap.Collapse(document.getElementById('sidebar'), {toggle: false});
                expander.style.display = 'block';
            }
        });
        </script>

        <!-- 文件列表 -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-file me-2"></i>文件
                </div>
                <div class="list-group list-group-flush">
                    <!-- 在面包屑导航下方添加视图切换按钮 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <nav aria-label="breadcrumb" class="flex-grow-1">
                            <ol class="breadcrumb bg-light p-3 rounded shadow-sm">
                                <li class="breadcrumb-item">
                                    <a href="{{ url_for('index') }}"><i class="fas fa-home"></i></a>
                                </li>
                                {% set parts = [] %}
                                {% for part in current_path.split('\\') if part %}
                                    {% if loop.first %}
                                        {% set _ = parts.append(part + '\\') %}
                                    {% else %}
                                        {% set _ = parts.append(part) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for part in parts %}
                                    <li class="breadcrumb-item {% if not loop.last %}active{% endif %}">
                                        {% if loop.last %}
                                            {{ part }}
                                        {% else %}
                                            <a href="{{ url_for('browse', dirpath=parts[:loop.index]|join('\\')) }}">
                                                {{ part }}
                                                {% if loop.first %}<i class="fas fa-level-up-alt ms-1"></i>{% endif %}
                                            </a>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ol>
                        </nav>
                        <!-- 在视图切换按钮组中添加列数选择 -->
                        <div class="btn-group ms-3">
                            <button class="btn btn-outline-secondary view-btn active" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="btn btn-outline-secondary view-btn" data-view="grid">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <!-- 添加单列/双列布局切换 -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-columns me-1"></i>列数
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item cols-mode" href="#" data-cols="1">单列布局</a></li>
                                    <li><a class="dropdown-item cols-mode" href="#" data-cols="2">双列布局</a></li>
                                    <li><a class="dropdown-item cols-mode" href="#" data-cols="auto">自动适配</a></li>
                                    <li><a class="dropdown-item cols-mode" href="#" data-cols="compact">紧凑模式</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 修改文件列表部分 -->
                    <div class="list-group list-group-flush view-list">
                        {% for file in files %}
                        <div class="list-group-item file-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas {{ get_file_icon(file.name) }} text-{{ get_file_color(file.name) }} me-2"></i>
                                {{ file.name }}
                            </div>
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-3">{{ file.size|filesizeformat }}</small>
                                <a href="{{ url_for('download', filepath=os.path.join(current_path, file.name) ) }}" 
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 添加宫格视图 -->
                    <!-- 修改宫格视图容器和卡片样式 -->
                    <!-- 修改宫格视图容器 -->
                    <div class="row g-2 view-grid d-none"
                         data-cols-md="4" data-cols-lg="6">
                        {% for file in files %}
                        <div class="col d-flex">
                            <div class="card h-100 shadow-sm file-item w-100">
                                <div class="card-body text-center d-flex flex-column">
                                    <!-- 修改宫格视图的图标部分 -->
                                    <div class="flex-grow-1">
                                        {% set ext = file.name.split('.')[-1].lower() %}
                                        {% if ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                        <img src="{{ url_for('download', filepath=os.path.join(current_path, file.name)) }}" 
                                             class="img-thumbnail mb-2 preview-media cursor-zoom"
                                             alt="{{ file.name }}"
                                             loading="lazy"
                                             data-bs-toggle="modal" 
                                             data-bs-target="#imageModal"
                                             data-img-src="{{ url_for('download', filepath=os.path.join(current_path, file.name)) }}"
                                             onclick="
                                                document.getElementById('fullImage').src = this.getAttribute('data-img-src');
                                                document.body.classList.add('modal-open');
                                             ">
                                        <!-- 添加图片预览指示器，提高移动设备上的可用性 -->
                                        <div class="image-zoom-indicator position-absolute top-0 end-0 m-2">
                                            <i class="fas fa-search-plus text-light"></i>
                                        </div>
                                        {% else %}
                                            {% if ext in ['mp4', 'avi', 'mov', 'mkv'] %}
                                            <div class="video-preview-container mb-2" style="width: 100%;">
                                                {% if file.thumbnail %}
                                                <!-- 显示视频缩略图 - 优化移动设备兼容性 -->
                                                <div class="position-relative">
                                                    <img src="{{ url_for('thumbnail', filepath=file.thumbnail) }}" 
                                                         class="img-thumbnail mb-2 preview-media cursor-zoom"
                                                         alt="{{ file.name }} 缩略图"
                                                         loading="lazy"
                                                         data-bs-toggle="modal"
                                                         data-bs-target="#videoModal"
                                                         data-video-src="{{ url_for('download', filepath=os.path.join(current_path, file.name)) }}"
                                                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIGZpbGw9IiM2YzZjNmMiLz48cGF0aCBkPSJNNDAgMzBMNzAgNTAgNDAgNzB6IiBmaWxsPSIjZmZmIi8+PC9zdmc+';"
                                                         onclick="prepareVideoModal(this.getAttribute('data-video-src'))">
                                                    <!-- 添加视频播放按钮覆盖层，提高移动设备上的可点击性 -->
                                                    <div class="video-play-overlay position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center">
                                                        <i class="fas fa-play-circle text-light fa-3x"></i>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <!-- 如果没有缩略图，显示视频播放器占位符 -->
                                                <div class="position-relative video-fallback-container" 
                                                     data-video-src="{{ url_for('download', filepath=os.path.join(current_path, file.name)) }}"
                                                     data-bs-toggle="modal"
                                                     data-bs-target="#videoModal"
                                                     onclick="prepareVideoModal(this.getAttribute('data-video-src'))">
                                                    <div class="d-flex justify-content-center align-items-center bg-dark rounded" style="height: 150px;">
                                                        <i class="fas fa-play-circle text-light fa-3x"></i>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% else %}
                                            <i class="fas {{ get_file_icon(file.name) }} text-{{ get_file_color(file.name) }} fa-2x mb-2"></i>
                                            {% endif %}
                                        {% endif %}
                                        <h6 class="card-title text-truncate mt-2" title="{{ file.name }}">{{ file.name }}</h6>
                                    </div>
                                    
                                    <!-- 添加预览样式 -->
                                    <style>
                                    /* 添加动画效果 */
                                    .animate__animated {
                                        animation-duration: 1s;
                                        animation-fill-mode: both;
                                    }
                                    .animate__pulse {
                                        animation-name: pulse;
                                    }
                                    .animate__infinite {
                                        animation-iteration-count: infinite;
                                    }
                                    @keyframes pulse {
                                        0% {
                                            transform: scale3d(1, 1, 1);
                                        }
                                        50% {
                                            transform: scale3d(1.1, 1.1, 1.1);
                                        }
                                        100% {
                                            transform: scale3d(1, 1, 1);
                                        }
                                    }
                                    .preview-media {
                                        max-width: 100%;
                                        width: 100%;  /* 新增宽度设置 */
                                        object-fit: contain;  /* 保持原始比例 */
                                        background-color: #f8f9fa;
                                        border-radius: 0.25rem;
                                    }
                                    .video-preview-container {
                                        position: relative;
                                        min-height: 150px;
                                        background-color: #343a40;
                                        border-radius: 0.25rem;
                                        display: flex;
                                        justify-content: center;
                                        align-items: center;
                                    }
                                    .video-fallback-container {
                                        cursor: pointer;
                                        border-radius: 0.25rem;
                                        overflow: hidden;
                                    }
                                    .video-play-overlay {
                                        background-color: rgba(0,0,0,0.3);
                                        border-radius: 0.25rem;
                                        cursor: pointer;
                                        transition: background-color 0.2s ease;
                                    }
                                    .video-play-overlay:hover {
                                        background-color: rgba(0,0,0,0.5);
                                    }
                                    .image-zoom-indicator {
                                        background-color: rgba(0,0,0,0.5);
                                        border-radius: 50%;
                                        width: 30px;
                                        height: 30px;
                                        display: flex;
                                        justify-content: center;
                                        align-items: center;
                                        opacity: 0.7;
                                        transition: opacity 0.2s ease;
                                    }
                                    .img-thumbnail:hover + .image-zoom-indicator,
                                    .image-zoom-indicator:hover {
                                        opacity: 1;
                                    }
                                    /* 优化iPad和移动设备上的触摸交互 */
                                    @media (pointer: coarse) {
                                        .video-play-overlay i,
                                        .image-zoom-indicator {
                                            opacity: 1;
                                            transform: scale(1.2);
                                        }
                                    }
                                    /* 视频缩略图加载失败时的样式 */
                                    .video-fallback-icon {
                                        width: 100%;
                                        height: 150px;
                                        object-fit: contain;
                                        background-color: #343a40;
                                    }
                                    /* iOS设备特定样式 */
                                    @supports (-webkit-touch-callout: none) {
                                        .video-preview-container {
                                            background-color: #343a40;
                                        }
                                        .video-play-overlay i {
                                            transform: scale(1.5);
                                        }
                                    }
                                    /* 移动设备特定样式 */
                                    .mobile-device .video-preview-container {
                                        background-color: #343a40;
                                        border: 1px solid rgba(255,255,255,0.1);
                                    }
                                    .mobile-device .video-play-overlay {
                                        opacity: 1;
                                    }
                                    .mobile-device .video-fallback-icon {
                                        background-size: 50px 50px;
                                        background-position: center;
                                        background-repeat: no-repeat;
                                    }
                                    /* iOS设备特定样式 */
                                    .ios-device .video-preview-container {
                                        background-color: #343a40;
                                        border: 1px solid rgba(255,255,255,0.1);
                                    }
                                    .ios-device .video-play-overlay {
                                        opacity: 1;
                                    }
                                    .ios-device .video-fallback-icon {
                                        background-size: 50px 50px;
                                        background-position: center;
                                        background-repeat: no-repeat;
                                    }
                                    .ios-video-container,
                                    .mobile-video-container {
                                        min-height: 150px;
                                    }
                                    </style>
                                    <div class="mt-2">
                                        <a href="{{ url_for('download', filepath=os.path.join(current_path, file.name) ) }}" 
                                           class="btn btn-sm btn-outline-secondary w-100">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 添加切换脚本 -->
                    <script>
                    // 视图切换功能
                    document.querySelectorAll('.view-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            // 切换按钮状态
                            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            
                            // 切换视图显示
                            const viewType = btn.dataset.view;
                            document.querySelector('.view-list').classList.toggle('d-none', viewType !== 'list');
                            document.querySelector('.view-grid').classList.toggle('d-none', viewType !== 'grid');
                            
                            // 保存视图偏好
                            localStorage.setItem('preferredView', viewType);
                        });
                    });
                    
                    // 列数模式切换功能
                    document.querySelectorAll('.cols-mode').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            const colsMode = item.dataset.cols;
                            const gridContainer = document.querySelector('.view-grid');
                            
                            // 移除所有列数相关的类
                            gridContainer.className = gridContainer.className.replace(/row-cols-\S+/g, '');
                            
                            // 根据选择的模式设置列数
                            if (colsMode === '1') {
                                // 单列布局
                                gridContainer.classList.add('row-cols-1');
                            } else if (colsMode === '2') {
                                // 双列布局
                                gridContainer.classList.add('row-cols-1', 'row-cols-md-2');
                            } else if (colsMode === 'auto') {
                                // 自动适配（默认响应式）
                                gridContainer.classList.add('row-cols-1', 'row-cols-md-3', 'row-cols-lg-4');
                            } else if (colsMode === 'compact') {
                                // 紧凑模式
                                gridContainer.classList.add('row-cols-2', 'row-cols-md-4', 'row-cols-lg-6');
                            }
                            
                            // 保存列数偏好
                            localStorage.setItem('preferredCols', colsMode);
                        });
                    });
                    
                    // 视频模态框准备函数 - 优化以支持iPad和移动设备
                    function prepareVideoModal(videoSrc) {
                        // 直接接收视频源URL作为参数，而不是DOM元素
                        const videoPlayer = document.getElementById('modalVideoPlayer');
                        const iOSHelper = document.getElementById('iOSPlayHelper');
                        const videoModal = document.getElementById('videoModal');
                        
                        if (videoPlayer) {
                            const videoSource = videoPlayer.querySelector('source');
                            // 确保URL是绝对路径
                            if (videoSrc && !videoSrc.startsWith('http')) {
                                // 如果是相对路径，转换为绝对路径
                                const baseUrl = window.location.origin;
                                if (!videoSrc.startsWith('/')) {
                                    videoSrc = '/' + videoSrc;
                                }
                                videoSrc = baseUrl + videoSrc;
                            }
                            videoSource.src = videoSrc;
                            videoPlayer.load();
                           
                            // 检测移动设备 - 改进的检测方法
                            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
                                       (/iPhone|iPad|iPod/.test(navigator.platform) || 
                                       (navigator.platform === 'MacIntel' && typeof navigator.standalone !== 'undefined'));
                            
                            // 显示播放助手，适用于所有移动设备
                            if (isMobile && iOSHelper) {
                                iOSHelper.classList.remove('d-none');
                                
                                // 为播放助手添加点击事件
                                iOSHelper.onclick = function() {
                                    videoPlayer.play()
                                        .then(() => {
                                            iOSHelper.classList.add('d-none');
                                        })
                                        .catch(err => {
                                            console.log('视频播放失败:', err);
                                            // 保持助手可见，显示错误提示
                                            const errorMsg = document.createElement('p');
                                            errorMsg.className = 'text-danger mt-2';
                                            errorMsg.textContent = '播放失败，请尝试下载后观看';
                                            iOSHelper.appendChild(errorMsg);
                                        });
                                };
                            } else {
                                // 非移动设备尝试自动播放
                                const playPromise = videoPlayer.play();
                                
                                if (playPromise !== undefined) {
                                    playPromise.catch(error => {
                                        // 自动播放被阻止，显示播放按钮
                                        console.log('自动播放被阻止，需要用户交互', error);
                                        if (iOSHelper) {
                                            iOSHelper.classList.remove('d-none');
                                            iOSHelper.onclick = function() {
                                                videoPlayer.play()
                                                    .then(() => {
                                                        iOSHelper.classList.add('d-none');
                                                    });
                                            };
                                        }
                                    });
                                }
                            }
                            
                            // 监听模态框关闭事件，重置视频状态
                            if (videoModal) {
                                videoModal.addEventListener('hidden.bs.modal', function() {
                                    videoPlayer.pause();
                                    if (iOSHelper) {
                                        iOSHelper.classList.remove('d-none');
                                        // 移除可能添加的错误消息
                                        const errorMsg = iOSHelper.querySelector('.text-danger');
                                        if (errorMsg) {
                                            errorMsg.remove();
                                        }
                                    }
                                });
                            }
                        }
                    }
                    
                    // 页面加载时初始化视图和列数
                    document.addEventListener('DOMContentLoaded', () => {
                        // 初始化视图类型
                        const preferredView = localStorage.getItem('preferredView') || 'list';
                        const activeBtn = document.querySelector(`.view-btn[data-view="${preferredView}"]`);
                        if(activeBtn) {
                            activeBtn.click();
                        }
                        
                        // 初始化列数模式
                        const preferredCols = localStorage.getItem('preferredCols') || 'auto';
                        const colsItem = document.querySelector(`.cols-mode[data-cols="${preferredCols}"]`);
                        if(colsItem) {
                            colsItem.click();
                        }
                        
                        // 检测iOS设备并优化视频播放体验
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                                     (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                        
                        if (isIOS) {
                            // 为iOS设备优化视频模态框
                            const videoModal = document.getElementById('videoModal');
                            const iOSHelper = document.getElementById('iOSPlayHelper');
                            const videoPlayer = document.getElementById('modalVideoPlayer');
                            
                            if (videoModal && iOSHelper && videoPlayer) {
                                // 显示iOS播放助手
                                iOSHelper.classList.remove('d-none');
                                
                                // 监听模态框显示事件
                                videoModal.addEventListener('shown.bs.modal', function() {
                                    // 点击助手时播放视频
                                    iOSHelper.addEventListener('click', function() {
                                        videoPlayer.play()
                                          .then(() => {
                                            iOSHelper.classList.add('d-none');
                                          })
                                          .catch(err => {
                                            console.error('播放失败:', err);
                                          });
                                    });
                                });
                                
                                // 监听模态框隐藏事件，重置状态
                                videoModal.addEventListener('hidden.bs.modal', function() {
                                    videoPlayer.pause();
                                    iOSHelper.classList.remove('d-none');
                                });
                            }
                            
                            // 优化图片预览
                            document.querySelectorAll('.img-thumbnail').forEach(img => {
                                img.style.WebkitTouchCallout = 'none'; // 禁用长按菜单
                            });
                        }
                    });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加瀑布流样式 -->
<!-- 添加排序功能和瀑布流切换 -->
<div class="d-flex justify-content-between align-items-center mb-4 px-3">
<div class="dropdown">
<button class="btn btn-purple dropdown-toggle" type="button" data-bs-toggle="dropdown">
<i class="fas fa-sort-alpha-down me-2"></i>排序
</button>
<ul class="dropdown-menu dropdown-menu-dark">
<li><a class="dropdown-item" href="?sort=name"><i class="fas fa-font me-2"></i>名称</a></li>
<li><a class="dropdown-item" href="?sort=size"><i class="fas fa-weight-hanging me-2"></i>大小</a></li>
<li><a class="dropdown-item" href="?sort=modified"><i class="fas fa-clock me-2"></i>修改时间</a></li>
</ul>
</div>
<div class="btn-group">
<button class="btn btn-outline-purple view-btn active" data-view="list">
<i class="fas fa-list"></i>
</button>
<button class="btn btn-outline-purple view-btn" data-view="masonry">
<i class="fas fa-th-large"></i>
</button>
</div>
</div>

<!-- 瀑布流布局 -->
<div class="masonry-grid view-masonry d-none">
{% for file in files %}
<div class="masonry-item">
<div class="card bg-gray-800 border-purple hover-shadow-lg transition-transform">
<div class="card-body position-relative">
<!-- 悬浮下载按钮 -->
<div class="hover-action position-absolute top-0 end-0 p-2 opacity-0">
<a href="{{ url_for('download', filepath=os.path.join(current_path, file.name) ) }}" 
   class="btn btn-sm btn-purple rounded-pill shadow-sm">
   <i class="fas fa-download"></i>
</a>
</div>
<h6 class="card-title text-truncate mt-2" title="{{ file.name }}">{{ file.name }}</h6>
</div>
</div>
</div>
{% endfor %}
</div>
</div>

<!-- 添加瀑布流动画 -->
<style>
/* 原有样式 */
.masonry-grid {
    column-count: 4;
    column-gap: 1.5rem;
    transition: all 0.3s ease;
}

/* 新增按钮动画 */
.btn-purple:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(111, 66, 193, 0.5);
    transition: all 0.2s ease-in-out;
}
.masonry-item {
break-inside: avoid;
margin-bottom: 1.5rem;
transform: translateY(0);
transition: transform 0.2s ease;
}
.masonry-item:hover {
transform: translateY(-5px);
}
.hover-action {
transition: opacity 0.3s ease, transform 0.2s ease;
transform: translateY(10px);
}
.card:hover .hover-action {
opacity: 1 !important;
transform: translateY(0);
}
</style>

<!-- 在文件列表底部添加Modal -->
<!-- 图片查看模态框 -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-body p-0 text-center position-relative">
                <img id="fullImage" class="img-fluid" src="" 
                     style="max-height: 90vh; max-width: 100%">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>

<!-- 视频播放模态框 -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-light">视频播放</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"
                        onclick="document.getElementById('modalVideoPlayer').pause();"></button>
            </div>
            <div class="modal-body p-0 text-center position-relative">
                <video id="modalVideoPlayer" class="w-100" controls playsinline webkit-playsinline style="max-height: 80vh;">
                    <source src="" type="video/mp4">
                    您的浏览器不支持HTML5视频播放。
                </video>
                <!-- 改进的移动设备兼容性提示 -->
                <div id="iOSPlayHelper" class="d-none position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex flex-column justify-content-center align-items-center" style="z-index: 1050;">
                    <i class="fas fa-play-circle text-light fa-5x mb-3 animate__animated animate__pulse animate__infinite"></i>
                    <p class="text-light fw-bold">点击播放视频</p>
                    <small class="text-light-emphasis">移动设备需要点击才能播放</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加关闭按钮样式 -->
    <style>
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    .btn-close-white:hover {
        opacity: 1;
    }
    </style>

    <!-- 在切换脚本中添加列数控制功能 -->
    <script>
    // 新增列数模式切换逻辑
    document.querySelectorAll('.cols-mode').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const grid = document.querySelector('.view-grid');
            if(e.target.dataset.cols === 'compact') {
                grid.dataset.colsMd = grid.dataset.colsMd;  // 保存原始值
                grid.dataset.colsLg = grid.dataset.colsLg;
                grid.classList.remove('row-cols-md-4', 'row-cols-lg-6');
                grid.classList.add('row-cols-md-5', 'row-cols-lg-8');
            } else {
                grid.classList.remove('row-cols-md-5', 'row-cols-lg-8');
                grid.classList.add('row-cols-md-4', 'row-cols-lg-6');
            }
            localStorage.setItem('colsMode', e.target.dataset.cols);
        });
    });
    
    // 初始化列数模式
    document.addEventListener('DOMContentLoaded', () => {
        const colsMode = localStorage.getItem('colsMode') || 'auto';
        if(colsMode === 'compact') {
            document.querySelector('.cols-mode[data-cols="compact"]').click();
        }
        
        // 检测移动设备并应用特定优化
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                     (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
                     (/iPhone|iPad|iPod/.test(navigator.platform) || 
                     (navigator.platform === 'MacIntel' && typeof navigator.standalone !== 'undefined'));
        
        // 为移动设备添加特定类
        if (isMobile) {
            document.body.classList.add('mobile-device');
            if (isIOS) {
                document.body.classList.add('ios-device');
            }
            
            // 预加载视频缩略图的占位SVG
            const placeholderImg = new Image();
            placeholderImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIGZpbGw9IiM2YzZjNmMiLz48cGF0aCBkPSJNNDAgMzBMNzAgNTAgNDAgNzB6IiBmaWxsPSIjZmZmIi8+PC9zdmc+';
            
            // 为所有视频容器添加移动设备特定样式
            document.querySelectorAll('.video-preview-container').forEach(container => {
                container.classList.add('mobile-video-container');
                if (isIOS) {
                    container.classList.add('ios-video-container');
                }
            });
            
            // 确保所有视频缩略图点击事件正常工作
            document.querySelectorAll('[data-video-src]').forEach(element => {
                element.addEventListener('click', function() {
                    prepareVideoModal(this.getAttribute('data-video-src'));
                });
            });
        }
    });
    </script>

    <!-- 添加响应式样式调整 -->
    <style>
    /* 自定义紧凑模式列数 */
    @media (min-width: 768px) {
        .row-cols-md-5 {
            --bs-columns: 5;
        }
        .row-cols-md-5 > * {
            flex: 0 0 20%;
            max-width: 20%;
        }
    }
    
    @media (min-width: 992px) {
        .row-cols-lg-8 {
            --bs-columns: 8;
        }
        .row-cols-lg-8 > * {
            flex: 0 0 12.5%;
            max-width: 12.5%;
        }
    }
    </style>


{% endblock %}  <!-- Correctly placed after ALL template content -->

<!-- 更新侧边栏状态跟踪脚本 -->
<script>
document.getElementById('sidebar').addEventListener('hidden.bs.collapse', function () {
    localStorage.setItem('sidebarCollapsed', 'true');
    document.querySelector('[data-bs-target="#sidebar"]').style.display = 'block';
});

document.getElementById('sidebar').addEventListener('shown.bs.collapse', function () {
    localStorage.removeItem('sidebarCollapsed');
    document.querySelector('[data-bs-target="#sidebar"]').style.display = 'none';
});

// 初始化侧边栏状态
document.addEventListener('DOMContentLoaded', () => {
    const sidebarToggle = document.querySelector('[data-bs-target="#sidebar"]');
    if(localStorage.getItem('sidebarCollapsed') === 'true') {
        new bootstrap.Collapse(document.getElementById('sidebar'), {toggle: false});
        sidebarToggle.style.display = 'block';
    } else {
        sidebarToggle.style.display = 'none';
    }
});
</script>